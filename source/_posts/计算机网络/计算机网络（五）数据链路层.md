---
title: 计算机网络（五）数据链路层
date: 2020-10-29 20:30:04
tags: 
    - 计算机网络
categories:
    - 计算机基础知识
    - 计算机网络
---



## 数据链路的作用
数据链路层协议规定了通过信息通信媒介互联的设备之间传输的规范。0，1等计算机二进制 -> 电压高低，光的闪灭以及电波强弱。

链路层的主体部分是在网络适配器（Network adapter）中实现的，网络适配器有时也称为网络接口卡（Network Interface Card， NIC）

## 数据链路的相关技术

### MAC地址 （Medium Access Control）
用于识别数据链路中互连的节点。长48比特。不会重复。


## Web页面请求的历程

### DHCP、UDP、IP和以太网（找本机IP）
DHCP四个步骤中仅有最后两个步骤是实际必要的。
1. 主机生成一个DHCP请求报文，并将这个报文放入具有目的端口67（DHCP服务器）和源端口68（DHCP客户）的UDP报文段中。
2. 该报文段被放入一个具有广播IP目的地址（255.255.255.255）和源IP地址（0.0.0.0)的IP数据报中，因为主机还没有一个IP地址。
3. 该IP数据报被放置在以太网帧中，该MAC帧具有目的MAC地址（FF:FF:FF:FF:FF:FF),将该帧广播到交换机连接的所有设备(顺利的话也包括DHCP服务器)；该帧的源MAC地址时主机的MAC地址。
4. 该帧是第一个由主机发送到以太网交换机中的帧。该交换机在所有的出端口广播入帧。
5. DHCP服务器的接口受到该帧，不断向上解析得到IP、UDP、DHCP报文，之后生成DHCP的ACK报文，该报文包括IP地址（CIDR分配策略），DNS服务器的IP地址、默认网关路由器的IP地址、子网掩码。将DHCP的ACK报文放入UDP报文段中，UDP报文段被放入IP数据报中，IP数据报在被放入一个以太网帧中。源MAC地址是服务器接口的MAC地址，目的MAC地址是主机MAC地址。
6. 以太网帧发送到交换机中，由于交换机是自学习的（记录每个接口对应的MAC地址），并且受到过主机的以太网帧，所以交换机仅向主机接口转发该帧。
7. 主机收到帧后，提取出IP数据报，取出UDP报文段，取出ACK报文。DHCP客户端记录下他的IP地址和他的DNS服务器的IP地址。并在**IP转发表**中安装默认网关的地址，主机会向网关发送目的地址为其子网以外的所有数据报。


### DNS、ARP（找网关MAC地址)
8. 主机会通过浏览器生成一个TCP套接字，用于向网站发送HTTP请求，但是需要知道网站的IP地址。
9. 主机的操作系统生成一个DNS查询报文，将网站的域名放入DNS报文的问题段中。将该报文放入一个目的端口号为53（DNS服务器）的UDP报文段中。该报文段被放入IP目的地址为DNS服务器，源地址为主机IP地址的IP数据报中。
10. 数据报会放入到以太网帧中。该帧将发送到网关路由器。但是主机通过DHCP过程只知道网关路由器的IP地址，不知道网关路由器的MAC地址。为了获取网关的MAC地址，需要使用ARP协议。
11. 主机生成一个具有目的IP地址为网关IP的ARP查询报文。放入到一个具有广播地址（FF:FF:FF:FF:FF:FF)的以太网帧中，并向交换机发送这个广播帧，交换机将帧发送给所有连接的设备，包括网关路由器。
12. 网关在收到该帧后，发现目标IP与自己IP匹配，所以要发送一个ARP回答，指示自己的MAC地址对应自己的IP地址。将ARP回答放入以太网帧中，目的地址为主机的MAC地址，向交换机发送该帧，由交换机发送给主机。
13. 主机收到该帧并抽取网关路由器的MAC地址，继续DNS解析过程。
14. 将包含DNS查询报文的数据报放入目的地址为网关MAC地址的以太网帧中，通过交换机发送给网关路由器。主机报文的IP目的地址是DNS服务器，MAC目的地址是网关服务器。
15. 网关接收到DNS查询的IP数据报后，根据IP数据报的目的地址选择转发给响应的路由器。
16. 路由器收到IP数据报后，根据目的地址和转发表确定出接口，根据内部网关协议（RIP、OSPF）和外部网关协议（BGP）配置路由器到DNS的路由表项（路由选择）。
17. DNS服务器收到数据报后，抽取DNS查询报文。并在DNS库中查找域名。
18. 找到包含对应域名的IP地址的DNS源记录后，向主机发送一个包含域名到IP地址映射的DNS回答报文，将该DNS回答报文放入UDP报文段、IP数据报中，通过路由器反转发给网关路由器，经过交换机到主机。
19. 主机从报文中抽取服务器的IP地址。


### TCP、HTTP
20. 有了服务器的IP地址之后，便生成TCP套接字，用该套接字向服务器发送HTTP GET报文。
21. 建立HTTP连接需要进行TCP连接，进行三次握手
22. 建立连接后发送HTTP的GET报文，将报文放入TCP报文段的载荷中，然后生成IP数据报送往服务器。
23. 服务器从TCP套接字中读取报文，生成HTTP响应报文，将页面内容放入HTTP响应体中，发送到主机。
24. 浏览器收到HTTP响应报文后抽取Web页面内容进行渲染，显示web页面。


![](https://raw.githubusercontent.com/Yqzzxlj/Image-Hosting/master/web%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B.png)

###  DNS解析

什么是DNS解析？当用户输入一个网址并按下回车键的时候，浏览器得到了一个域名。而在实际通信过程中，我们需要的是一个IP地址。因此我们需要先把域名转换成相应的IP地址，这个过程称作DNS解析。

1.  浏览器首先搜索浏览器自身缓存的DNS记录。
2.  如果浏览器缓存中没有找到需要的记录或记录已经过期，则搜索hosts文件和操作系统缓存。
3.  如果在hosts文件和操作系统缓存中没有找到需要的记录或记录已经过期，则向域名解析服务器发送解析请求。
4.  如果域名解析服务器也没有该域名的记录，则开始递归+迭代解析。
5.  获取域名对应的IP后，一步步向上返回，直到返回给浏览器。

至此，浏览器就得到了url的IP地址。

###  发起TCP请求

建立TCP连接的过程就是三次握手过程。

1. 客户端向服务器端发送连接请求的报文；
2. 服务器端收到请求后，同意建立连接，向客户端发送确认报文；
3. 客户端收到服务器端的确认报文后，再次向服务器端发出报文，确认已收到确认报文。

至此，浏览器与服务器已经建立了TCP连接，开始进行通信。

### 建立TCP连接后，浏览器向服务器发送HTTP请求

### 负载均衡

什么是负载均衡？ 当一台服务器无法支持大量的用户访问时，将用户分摊到两个或多个服务器上的方法叫负载均衡。

1. 一般，如果我们的平台配备了负载均衡的话，前一步DNS解析获得的IP地址应该是我们Nginx负载均衡服务器的IP地址。所以我们的浏览器将我们的网页请求发送到了Nginx负载均衡服务器上。
2. Nginx根据我们设定的分配算法和规则，选择一台后端的真实Web服务器，与之建立TCP连接，并转发我们浏览器发出去的页面请求。
3. Web服务器收到请求，产生响应，并肩网页发送给Nginx负载均衡服务器。
4. Nginx负载均衡服务器将网页传递给filters链处理。之后发回给我们的浏览器。


###  服务器响应HTTP请求，将请求的指定资源发送给服务器

###  浏览器释放TCP连接

释放TCP连接的过程就是四次挥手的过程

1. 浏览器向服务器发送释放连接报文；
2. 服务器收到释放报文后，发出确认报文，然后将服务器上未传送完的数据发送完；
3. 服务器数据传输完成后，向浏览器发送释放连接请求；
4. 浏览器收到报文后，发出确认，然后等待一段时间后，释放TCP连接。

###  浏览器渲染

1. 浏览器根据页面内容，生成DOM Tree。根据CSS内容，生成CSS Rule Tree(规则树)。调用JS执行引擎执行JS代码。
2. 根据DOM Tree和CSS Rule Tree生成Render Tree(呈现树)
3. 根据Render Tree渲染网页


## 相关问题

### 为什么有了 MAC 地址还要 IP 地址，IP 地址和 MAC 地址的区别是什么

一. 整体与局部信息传递时候，需要知道的其实是两个地址：终点地址（Final destination address）下一跳的地址（Next hop address）IP地址本质上是终点地址，它在跳过路由器（hop）的时候不会改变，而MAC地址则是下一跳的地址，每跳过一次路由器都会改变。这就是为什么还要用MAC地址的原因之一，它起到了记录下一跳的信息的作用。注：一般来说IP地址经过路由器是不变的，不过NAT（Network address translation）例外，这也是有些人反对NAT而支持IPV6的原因之一。

二. 分层实现如果在IP包头（header）中增加了”下一跳IP地址“这个字段，在逻辑上来说，如果IP地址够用，交换机也支持根据IP地址转发（现在的二层交换机不支持这样做），其实MAC地址并不是必要的。但用MAC地址和IP地址两个地址，用于分别表示物理地址和逻辑地址是有好处的。这样分层可以使网络层与链路层的协议更灵活地替换，网络层不一定非要用『IP』协议，链路层也不一定非用『以太网』协议。这就像OSI七层模型，TCP/IP五层模型其实也不是必要的，用双层模型甚至单层模型实现网络也不是不可以的，只是那样做很蛋疼罢了。

三. 早期的『以太网』实现早期的以太网只有集线器（hub），没有交换机（switch），所以发出去的包能被以太网内的所有机器监听到，因此要附带上MAC地址，每个机器只需要接受与自己MAC地址相匹配的包。
 
 
MAC地址，意译为媒体访问控制，或称为物理地址、硬件地址，用来定义网络设备的位置。IP地址是IP协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。

IP地址和MAC地址区别：

1、MAC地址是物理地址，IP地址是逻辑地址。就是说MAC地址是不可改变的，IP地址是可以更改的；

2、MAC地址具有唯一性，每个硬件出厂时候的MAC地址是固定的；IP地址不具备唯一性，因此，很多应用软件是围绕MAC地址开发的。

3、工作层次不同

二层基于MAC地址转发数据帧，三层基于IP地址转发报文。二层交换机基于MAC地址表转发数据，路由器基于路由表（IP地址）转发数据。

4、长度定义

MAC地址是Ethernet网卡上带的地址，长度为48位；IP地址目前主流是32位长。IP地址和MAC地址通过ARP协议联系到一起。

### 如何理解广播域和冲突域
+ 1、冲突域：

【定义】在同一个冲突域中的每一个节点都能收到所有被发送的帧。简单的说就是同一时间内只能有一台设备发送信息的范围。

【分层】基于OSI的第一层物理层

【设备】第二层设备能隔离冲突域，比如Switch。交换机能缩小冲突域的范围，交换接的每一个端口就是一个冲突域。

+ 2、广播域：

【定义】网络中能接收任一设备发出的广播帧的所有设备的集合。简单的说如果站点发出一个广播信号，所有能接收收到这个信号的设备范围称为一个广播域。

【分层】基于OSI的第二层数据链路层

【设备】第三层设备才能隔离广播域，比如Router。路由器能隔离广播域，其每一个端口就是一个广播域。

### 路由器和交换机有什么区别？
+ 工作层次不同：
 
交换机主要工作在数据链路层（第二层）

路由器工作在网络层（第三层）。

+ 转发依据不同：

交换机转发所依据的对象时：MAC地址。（物理地址）

路由转发所依据的对象是：IP地址。（网络地址）

+ 主要功能不同：

交换机主要用于组建局域网，而路由主要功能是将由交换机组好的局域网相互连接起来，或者接入Internet。

交换机能做的，路由都能做。交换机不能分割广播域，路由可以。路由还可以提供防火墙的功能。路由配置比交换机复杂。

