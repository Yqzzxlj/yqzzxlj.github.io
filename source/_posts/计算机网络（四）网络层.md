---
title: 计算机网络（四）网络层
date: 2020-10-29 20:26:49
tags: 
    - 计算机网络
categories:
    - 计算机基础知识
    - 计算机网络
---
### 4.1 网络层概述

网络层能够被分解为两个相互作用的部分，即数据平面和控制平面
数据平面的主要作用是从其输入链路向其输出链路转发数据报；控制平面的主要作用是协调这些本地的路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端传输。

### 转发和路由选择：数据平面和控制平面

**转发**是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。（硬件）

**路由选择**是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。（软件）

## 路由器工作原理

## 网际协议：IPv4、寻址、IPv6及其他 

IP地址属于网络层地址

IP属于面向无连接型

### IPv4 数据报格式
![](https://raw.githubusercontent.com/Yqzzxlj/Image-Hosting/master/IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)
+ **版本号**。由4比特构成，表示标识IP首部的版本号。字段值为4。
+ **首部长度**。由4比特构成，表明IP首部的大小。因为IPv4包含一些可变数量的选项。
+ **服务类型**。由8比特构成，表明服务质量。（优先级、时延、吞吐量）
+ **数据报长度**。由16比特构成，表示IP数据报的总长度。
+ **标识**。由16比特构成。用于分片重组。同一个分片的标识值相同，不同分片的标识值不同。
+ **标志**。由3比特构成。表示包被分片的相关信息。
+ **片偏移**。由13比特构成。用来表示被分片的每一个分段相对于原始数据的位置。
+ **生存时间（Time To Live，TTL）**。由8比特构成。表示可以中转多少个路由器，每经过一个路由器，TTL会减少1，直到变成0则丢弃该包。
+ **上层协议**。由8比特构成，表示IP数据报的数据部分应该交给哪个协议。
+ **首部检验和**。由16比特构成，校验数据报的首部，不校验数据部分。用来确保IP数据报不被破坏。
+ **源地址**。由32比特构成，表示发送端IP地址
+ **目标地址**。由32比特构成，表示接受端IP地址
+ **可选项**。 长度可变，在实验或诊断时使用，包括安全级别、源路径、路径记录、时间戳。
+ **数据**。存入数据。包括IP上层协议的首部。


### IPv4数据报分片

一个链路层帧能承载的最大数据量叫作最大传送单元（Maximun Transmission Unit， MTU）。每种数据链路的最大传输单元都不近相同。

路由器将IP数据报分片但不会进行重组，重组只能由目标主机进行。

### IPv4编址

主机与物理链路之间的边界叫接口。一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。

IPv4地址由32位比特组成。每8位分成一组，分成4组，以"."隔开，再将每组数转化为十进制数。

IPv4地址由网络标识（网络地址）和主机标识（主机地址）两部分组成。

子网掩码将原网络分为多个物理网络。

物件别域间路由选择（Classless Interdomain Routing， CIDR） 和
可变长子网掩码（Variable Length Subnet Mask， VLSM）技术采用任意长度分割IP地址的网络标识和主机标识。

广播地址。把IP地址中的主机地址部分全部设置为1，就成了广播地址。
在本网络内的广播叫本地广播，不同网络之间的广播叫直接广播。

多播。多播用于将包发送给特定组内的所有主机。

对于没有连接互联网的独立网络中的主机，只要保证在这个网络每地址唯一，可以不用考虑互联网即可配置响应的IP地址。私有网络的IP地址

+   A类 10.0.0.0 ~ 10.255.255.255（10/8）
+   B类 172.16.0.0 ~ 172.31.255.255（172.16/12）
+   C类 192.168.0.0 ~ 192.168.255.255（192.168/16）
包含在这个范围内的IP地址都属于私有IP，在此之外的IP称为全局IP。


### 4.3.5 IPv6

#### 1. IPv6数据报格式
![](https://raw.githubusercontent.com/Yqzzxlj/Image-Hosting/master/IPv6%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)

**版本**。 由4比特构成。6.

**流量类型** 由8比特构成。与IPv4中TOS字段含义相似。

**流表签** 由20比特构成。用于标识一条数据报的流。

**有效载荷长度** 由16比特构成。有效载荷指包的数据部分。

**下一个首部** 由8比特构成，相当于IPv4的协议字段

**跳限制** 由8比特构成，相当于IPv4的TTL。

**源地址** 由128比特构成。表示发送端IP地址

**目的地址** 由128比特构成。表示接受端IP地址。

与IPv4数据报的几个字段不复存在：
+ 分片/重新组装： IPv6不允许在中间路由器上进行分片与重新组装。这种操作只能在源与目的地执行。
+ 首部检验和： IP分组关注的重点是快速处理。减轻路由器负荷。
+ 选项： 选项字段不再是首部的一部分，但他没有消失，可能出现在“下一个首部”指出的位置上。


#### IPv6的必要性
+ 解决IPv4地址耗尽的问题
+ 弥补IPv4中的大多数缺陷


#### IPv6的特点
+ IP地址的扩大与路由控制表的聚合
+ 性能提升：包首部采用固定的值（40字节），不再采用首部检验码，简化首部结构，减轻路由器负荷。路由器不再做分片处理。
+ 支持即插即用功能：即使没有DHCP服务器也可以实现自动分配IP地址
+ 采用认证与加密功能：应对伪造IP地址的网络安全功能以及防止线路窃听的功能（IPsec）
+ 多播、MobileIP称为扩展功能



## IP协议相关技术

### DNS

主机名到IP地址转换的目录服务。 域名系统：（Domain Name System， DNS）



+ 主机向本地DNS服务器发送DNS查询报文，
+ 本地DNS服务器将查询报文发送到根DNS服务器。
+ 根服务器注意到edu前缀并向本地DNS服务器返回负责edu的TLD（Top-Level Domain， 顶级域）的IP地址列表。
+ 本地DNS服务器在向这些TLD服务器之一发送查询报文。
+ TLD服务器注意到umass.edu前缀，并用权威DNS服务器的IP地址进行响应。
+ ...

### ARP 

网络层地址（IP地址）和链路层地址（MAC地址）的转换。 地址解析协议（Address Resolution Protocol）

通过广播发送一个ARP请求包。
接受到包的主机发现目标IP与自己IP一致，就将自己的MAC地址返回。

#### RARP （Reverse Address Resolution Protocol）

由MAC地址定位IP地址的协议

### ICMP （Internet Control Message Protocol）

因特网控制报文协议。被主机和路由器用来彼此沟通网络层的信息。（确认网络是否正常工作，遇到异常问题时进行诊断）

ICMP报文是IP的有效载荷。

#### ICMP目标不可达消息（类型3）
#### ICMP重定向消息（类型5）
#### ICMP超时消息（类型11）
    TTL减为0时包被丢弃
#### ICMP回送消息（类型0、8）
    ping
#### ICMP原点抑制消息（类型4）
    缓和网络拥堵
#### ICMP路由器探索消息（类型9、10）
    发现与自己相连网络中的路由器。探索10，返回9.
#### ICMP地址掩码消息（类型17,18)
    17发送、18返回。

### DHCP（Dynamic Host Configuration）动态主机配置协议

实现自动设置IP地址、统一管理IP地址分配。实现即插即用。

1. DHCP服务器发现：使用DHCP发现报文来寻找与其交互的DHCP服务器（广播目的地址255.255.255.255， 本机源IP地址0.0.0.0)
2. DHCP服务器提供：可能存在多个DHCP服务器。每台服务器提供的报文包含发现报文的事务ID、IP地址、网络掩码以及IP地址租用期。（广播目的地址255.255.255.255）
3. DHCP服务器请求：主机从一个或多个提供中选择一个，用DHCP请求报文进行响应。
4. DHCP ACK：服务器用DHCP ACK报文进行响应。交互完成。


### NAT（Network Address Translation） 网络地址转换
在本地网络中使用私有地址，在连接互联网时使用全局IP地址的技术。除了转换IP地址外，还出现了可以转换TCP、UDP端口号的NAPT（Network Address Ports Translater）技术，由此可以实现一个全局IP地址与多个主机的通信。

NAT路由器上都有一张NAT转换表，包含了端口号及IP地址。

### IP隧道

两端的网络使用IPv6，中间的网络使用IPv4.

### 其他IP相关技术

#### IP多播
    多播用于将包发送给特定组内的所有主机。在采用多播功能之前，一直使用广播的方式，将数据发给所有主机再由IP之上的协议去判断是否接受。这样造成不必要的流量，且广播无法穿透路由。但是多播可以。
#### IP任播
    像110或119一样，为提供同一种服务的服务器配置同一个IP地址，并与最近的服务器进行通信。
#### 通信质量控制
#### 显示拥塞通知
#### Mobile IP
    移动设备每连接到不同的子网，都会由DHCP或手动的方式分配到不同的IP地址。无法进行TCP通信。